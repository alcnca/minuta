<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Minuta de Reunión - Formulario</title>
<style>
  :root{ --b:#000; --g:#f6f6f6; }
  *{ box-sizing:border-box }
  body{ font-family: Arial, Helvetica, sans-serif; margin:24px; color:#111 }

  /* Encabezado */
  .header{ display:grid; grid-template-columns:100px 1fr; gap:12px; align-items:center; border-bottom:2px solid var(--b); padding-bottom:10px; margin-bottom:16px }
  .header__logo{ width:90px; height:90px; object-fit:contain }
  .header__text h1{ font-size:18px; margin:0; text-transform:uppercase; letter-spacing:.5px }
  .header__text p{ margin:2px 0 0 0; font-size:12px }

  .box{ border:2px solid var(--b); padding:10px }
  .row{ display:grid; grid-template-columns:1fr 240px; gap:10px }
  .lbl{ font-weight:bold; margin-bottom:6px }
  .inline{ display:grid; grid-template-columns:1.2fr 1fr 1fr 1.8fr; gap:10px }
  .cell{ border:2px solid var(--b); padding:8px }
  .cell .lbl{ margin:0 0 6px 0 }

  input[type="text"], input[type="date"], input[type="time"], select, textarea{
    width:100%; padding:6px 8px; border:1px solid #333; border-radius:4px; font-size:14px;
  }

  /* === Participantes === */
  table{ width:100%; border-collapse:collapse; margin-top:8px; table-layout:auto; }
  /* Fijamos # y Firma; Nombre y Área se autoajustan (ancho no fijado) */
  col.col-num{ width:44px }
  col.col-firma{ width:30% }
  th, td{ border:2px solid var(--b); padding:7px 8px; font-size:14px }
  th{ text-align:center; background:var(--g) }
  td.num{ text-align:center }
  td.nombre{ text-transform:uppercase } /* NOMBRE en mayúsculas */

  /* Firma autógrafa: gran altura + línea */
  td.asistencia{ padding:0 }
  .firma-box{
    height:100%; display:flex; flex-direction:column; justify-content:flex-end;
    min-height:90px;           /* pantalla */
  }
  .firma-line{ border-top:1px solid #000; margin:0 12px 6px 12px; }
  .firma-txt{ font-size:11px; text-align:center; color:#444; margin:0 0 6px 0 }

  .actions{ display:flex; gap:8px; margin-top:14px; flex-wrap:wrap }
  .btn{ padding:10px 14px; border:0; border-radius:8px; cursor:pointer; font-weight:600; background:#0b4fb3; color:#fff }
  .btn.secondary{ background:#555 }
  .btn.small{ padding:6px 10px; font-size:12px }
  .hint{ font-size:12px; color:#444 }

  /* === Modal genérico === */
  dialog::backdrop{ background:rgba(0,0,0,.35) }
  dialog{ border:0; border-radius:12px; padding:0; max-width:720px; width:95%; box-shadow:0 20px 60px rgba(0,0,0,.35); overflow:hidden }
  .modal-head{ padding:14px 16px; background:#0b4fb3; color:#fff; font-weight:700 }
  .modal-body{ padding:10px 16px; max-height:60vh; overflow:auto }
  .modal-foot{ padding:12px 16px; display:flex; gap:10px; justify-content:flex-end; background:#f1f1f1 }
  .list{ display:grid; grid-template-columns:1fr 220px 120px; gap:8px; align-items:center }
  .list.head{ font-weight:700; border-bottom:1px solid #ddd; padding-bottom:6px; margin-bottom:6px }
  .pill{ font-size:12px; padding:2px 8px; border-radius:999px; background:#eef }
  .srch{ display:flex; gap:8px; margin:8px 0 12px }
  .srch input{ flex:1 }

  /* === Orden del Día === */
  .seccion-title{ font-weight:bold; margin:16px 0 6px 0 }
  .tabla-od{ width:100%; border-collapse:collapse }
  .tabla-od th, .tabla-od td{ border:2px solid #000; padding:6px 8px; }
  .tabla-od th{ background:#f6f6f6 }
  .tabla-od .num{ width:44px; text-align:center }
  .tabla-od .tema{ text-transform:uppercase }

  /* Impresión */
  @media print{
    .actions, .hint, #btnAbrirModal, #btnObjetivo { display:none!important }
    input, select, textarea { border:0; padding:0; outline:0 }
    .cell, .box, th, td { border:1px solid #000 }
    body{ margin:10mm }
    .header{ border-bottom:1px solid #000; padding-bottom:6px; margin-bottom:8px }
    .firma-box{ min-height:28mm } /* altura para firma en papel */
  }
</style>
</head>
<body>

<!-- Encabezado -->
<section class="header">
  <img class="header__logo" src="logo.png" alt="Logo">
  <div class="header__text">
    <h1>COOPERATIVA ACREIMEX</h1>
    <p>Coordinación de Recuperación Preventiva y Administrativa</p>
    <p class="hint">Formato de Minuta de Reunión</p>
  </div>
</section>

<!-- Objetivo / Fecha -->
<div class="row">
  <div class="box">
    <div class="lbl">Objetivo:</div>
    <textarea id="objetivoView" readonly placeholder="(Capturar objetivo desde la ventana)…" style="text-transform:uppercase"></textarea>
    <div class="actions" style="margin-top:8px">
      <button class="btn small" id="btnObjetivo">Capturar / editar objetivo</button>
    </div>
  </div>
  <div class="box">
    <div class="lbl">Fecha:</div>
    <input type="date" id="fecha">
  </div>
</div>

<!-- Sucursal / Horas / Convoca -->
<div class="inline">
  <div class="cell">
    <div class="lbl">Sucursal:</div>
    <select id="sucursalSelect" disabled>
      <option value="">Cargando sucursales…</option>
    </select>
  </div>
  <div class="cell">
    <div class="lbl">Hora inicio</div>
    <input type="time" id="horaInicio">
  </div>
  <div class="cell">
    <div class="lbl">Hora fin</div>
    <input type="time" id="horaFin">
  </div>
  <div class="cell">
    <div class="lbl">Convoca:</div>
    <input id="convoca" list="convocaList" placeholder="SELECCIONA QUIÉN CONVOCA…" autocomplete="off" title="">
    <datalist id="convocaList"></datalist>
  </div>
</div>

<!-- Botones asistentes -->
<div class="actions" style="margin-top:10px">
  <button class="btn" id="btnAbrirModal" disabled>Elegir asistentes de la sucursal</button>
  <span class="hint">Selector alimentado desde JSON (SUCURSAL, NOMBRECOMPLETO, PUESTO).</span>
</div>

<!-- Participantes -->
<div class="box" style="margin-top:12px">
  <div class="lbl" style="margin-bottom:6px">Participantes:</div>
  <table id="tabla">
    <colgroup>
      <col class="col-num"><col><col><col class="col-firma">
      <!-- col 2 (Nombre) y col 3 (Área) sin ancho => se autoajustan -->
    </colgroup>
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Área</th><!-- PUESTO -->
        <th>Asistencia</th><!-- Firma -->
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- ORDEN DEL DÍA -->
<div class="seccion-title">ORDEN DEL DÍA</div>
<table class="tabla-od" id="tablaOD">
  <thead>
    <tr><th class="num">#</th><th>Tema</th></tr>
  </thead>
  <tbody>
    <tr><td class="num">1.</td><td class="tema" contenteditable="true">PASE DE LISTA DEL PERSONAL CONVOCADO</td></tr>
    <tr><td class="num">2.</td><td class="tema" contenteditable="true">REUNIÓN Y CAPACITACIÓN RESPECTO AL TEMA</td></tr>
    <tr><td class="num">3.</td><td class="tema" contenteditable="true">RESUMEN DE ACTIVIDADES REALIZADAS Y RECOMENDACIONES GENERALES</td></tr>
    <tr><td class="num">4.</td><td class="tema" contenteditable="true">CIERRE Y FIRMA DE ASISTENCIA Y COMPROMISOS DE LOS ASISTENTES</td></tr>
  </tbody>
</table>
<div class="actions">
  <button class="btn small" id="agregarTema">+ Agregar tema</button>
</div>

<div class="actions">
  <button class="btn" onclick="window.print()">Imprimir</button>
  <button class="btn secondary" id="btnLimpiarTabla">Limpiar participantes</button>
</div>

<!-- Modal asistentes -->
<dialog id="modal">
  <div class="modal-head">Seleccionar asistentes</div>
  <div class="modal-body">
    <div class="srch">
      <input id="buscar" type="text" placeholder="Buscar por nombre o puesto…">
      <span class="pill" id="cuentaSeleccionados">0 seleccionados</span>
    </div>
    <div class="list head">
      <div>Nombre</div><div>Puesto</div><div>Incluir</div>
    </div>
    <div id="contenedorPersonal"></div>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" id="cerrarModal">Cancelar</button>
    <button class="btn" id="confirmarSeleccion">Agregar a la minuta</button>
  </div>
</dialog>

<!-- Modal Objetivo -->
<dialog id="modalObjetivo">
  <div class="modal-head">Capturar objetivo de la reunión</div>
  <div class="modal-body">
    <textarea id="objetivoInput" placeholder="Escribe aquí el objetivo… (se guardará en MAYÚSCULAS)" style="width:100%; min-height:120px;"></textarea>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" id="cancelObjetivo">Cancelar</button>
    <button class="btn" id="saveObjetivo">Guardar objetivo</button>
  </div>
</dialog>

<script>
/* ====== RUTA DEL JSON ====== */
const DATA_URL = "https://raw.githubusercontent.com/alcnca/minuta/refs/heads/main/Personal.json";

/* ====== LISTA “CONVOCA” ====== */
const CONVOCA_LIST = [
  ["SANDRA LORENA PACHECO ROBLES","ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["ROLANDO VALERIANO HURTADO","ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["ANDREA ACELA MORGA  DÁVILA","ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["GUSTAVO ESTUDILLO DE LA CRUZ","ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["ZOIBETH YANELI SORIANO IBAÑEZ","ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA"],
  ["ABEL EDUARDO JIMENEZ GASPAR","ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA"],
  ["DANIEL SÁNCHEZ DÍAZ","COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["FRANCISCO ANTONIO PÉREZ RODRIGUEZ","COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["ROBERTO JAVIER PÉREZ SANTIAGO","COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["INÉS ANDRADE  MÉNDEZ","COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL"],
  ["ALFONSO  JERÓNIMO HERNÁNDEZ","COORDINADOR DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA"],
  ["FRANCISCO DAMIAN MARTIN CORONADO","ANALISTA DE CRÉDITOS AGRONEGOCIOS REGIONAL"],
  ["VIRGINIA ESTEPHANIA CISNEROS TRUJILLO","COORDINADOR DE CRÉDITO REGIONAL"],
  ["ALONSO CANCHE CASTILLO","COORDINADOR DE RECUPERACIÓN REGIONAL"],
  ["IVANI LAINES ARCOS","GESTOR DE RECUPERACIÓN REGIONAL"],
  ["SUEMY ANAHÍ RUIZ ORDOÑEZ","PROMOTOR DE CAPTACIÓN REGIONAL"],
  ["ARACELLY BEATRIZ CUTIZ CAUICH","PROMOTOR DE CRÉDITO REGIONAL"],
  ["JORGE FRANCISCO SUASTE KU","PROMOTOR DE CRÉDITO REGIONAL"],
  ["MARIA LOURDES CAUICH MAY","SUPERVISOR DE SUCURSALES REGIONAL"]
];

/* ====== Refs ====== */
const tbody = document.getElementById('tbody');
const modal = document.getElementById('modal');
const contPersonal = document.getElementById('contenedorPersonal');
const buscar = document.getElementById('buscar');
const cuenta = document.getElementById('cuentaSeleccionados');
const sucSel = document.getElementById('sucursalSelect');
const btnAbrirModal = document.getElementById('btnAbrirModal');
const btnLimpiarTabla = document.getElementById('btnLimpiarTabla');
const horaInicio = document.getElementById('horaInicio');
const horaFin = document.getElementById('horaFin');
const convocaInput = document.getElementById('convoca');
const convocaList = document.getElementById('convocaList');
const objetivoView = document.getElementById('objetivoView');
const modalObjetivo = document.getElementById('modalObjetivo');
const objetivoInput = document.getElementById('objetivoInput');

/* ====== Helpers ====== */
function crearFilas(n){
  tbody.innerHTML = '';
  for(let i=1;i<=Math.max(1,n);i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${i}.</td>
      <td class="nombre"></td>
      <td class="area"></td>
      <td class="asistencia">
        <div class="firma-box">
          <div class="firma-line"></div>
          <p class="firma-txt">Firma</p>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
}
// arranque: sin asistentes aún
crearFilas(9);

/* Hora fin +1h */
function addMinutesToTimeStr(hhmm, minutes){
  if(!hhmm) return '';
  const [h,m] = hhmm.split(':').map(x=>parseInt(x||'0',10));
  let total = h*60 + m + minutes;
  total = (total + 1440) % 1440;
  const hh = String(Math.floor(total/60)).padStart(2,'0');
  const mm = String(total%60).padStart(2,'0');
  return `${hh}:${mm}`;
}
horaInicio.addEventListener('change', ()=> {
  if(horaInicio.value){ horaFin.value = addMinutesToTimeStr(horaInicio.value, 60); }
});

/* Convoca datalist (valor completo) */
function poblarConvoca(){
  convocaList.innerHTML = '';
  CONVOCA_LIST.forEach(([nombre, puesto])=>{
    const texto = `${nombre} — ${puesto}`.toUpperCase();
    const opt = document.createElement('option');
    opt.value = texto;
    convocaList.appendChild(opt);
  });
}
poblarConvoca();
convocaInput.addEventListener('input', ()=> {
  convocaInput.value = convocaInput.value.toUpperCase();
  convocaInput.title = convocaInput.value;
});

/* Cargar JSON y agrupar por sucursal */
let personasPorSucursal = {};
let listaActual = [];

async function cargarJSON(){
  try{
    const res = await fetch(DATA_URL, {cache:'no-store'});
    const data = await res.json();
    const arr = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
    personasPorSucursal = {};
    arr.forEach(row=>{
      const suc = (row.SUCURSAL || row.sucursal || '').toString().trim();
      const nom = (row.NOMBRECOMPLETO || row.nombre || row.NOMBRE || '').toString().trim();
      const puesto = (row.PUESTO || row.puesto || row.AREA || '').toString().trim();
      if(!suc || !nom) return;
      if(!personasPorSucursal[suc]) personasPorSucursal[suc] = [];
      personasPorSucursal[suc].push({ nombre: nom, puesto, raw: row });
    });

    sucSel.innerHTML = `<option value="">Seleccione sucursal…</option>`;
    Object.keys(personasPorSucursal).sort((a,b)=>a.localeCompare(b,'es'))
      .forEach(suc=>{
        const opt = document.createElement('option');
        opt.value = suc; opt.textContent = suc;
        sucSel.appendChild(opt);
      });

    sucSel.disabled = false; btnAbrirModal.disabled = false;
  }catch(e){
    console.error(e);
    sucSel.innerHTML = `<option value="">No se pudo cargar el JSON</option>`;
  }
}
cargarJSON();

/* Modal de asistentes */
function renderLista(personas){
  listaActual = personas.map((p,idx)=> ({...p, idx, checked:false}));
  applyFilter('');
}
function applyFilter(q){
  const txt = (q||'').toLowerCase().trim();
  contPersonal.innerHTML = '';
  listaActual.forEach(item=>{
    const nombre = item.nombre || '';
    const puesto = item.puesto || '';
    const ok = !txt || nombre.toLowerCase().includes(txt) || puesto.toLowerCase().includes(txt);
    if(!ok) return;
    const row = document.createElement('div');
    row.className = 'list';
    row.innerHTML = `
      <div>${nombre.toUpperCase()}</div>
      <div>${puesto}</div>
      <div style="text-align:center">
        <input type="checkbox" data-idx="${item.idx}" ${item.checked?'checked':''}>
      </div>
    `;
    contPersonal.appendChild(row);
  });
  cuenta.textContent = `${listaActual.filter(x=>x.checked).length} seleccionados`;
}
document.getElementById('buscar')?.addEventListener('input', e=> applyFilter(e.target.value));
contPersonal.addEventListener('change', (e)=>{
  const idx = +e.target.getAttribute('data-idx');
  const it = listaActual.find(x=>x.idx===idx);
  if(it){ it.checked = e.target.checked; }
  cuenta.textContent = `${listaActual.filter(x=>x.checked).length} seleccionados`;
});
btnAbrirModal.addEventListener('click', ()=>{
  const suc = sucSel.value;
  if(!suc){ alert('Primero selecciona una sucursal.'); return; }
  const personas = personasPorSucursal[suc] || [];
  if(personas.length===0){ alert('Esta sucursal no tiene personal en el JSON.'); return; }
  renderLista(personas);
  try{ modal.showModal(); }catch{ modal.setAttribute('open','true'); }
});
document.getElementById('cerrarModal').addEventListener('click', ()=>{
  try{ modal.close(); }catch{ modal.removeAttribute('open'); }
});
document.getElementById('confirmarSeleccion').addEventListener('click', ()=>{
  const sel = listaActual.filter(x=>x.checked);
  if(sel.length===0){ alert('Selecciona al menos una persona.'); return; }

  /* FILAS = exactamente el número de asistentes seleccionados */
  crearFilas(sel.length);

  const filas = [...tbody.querySelectorAll('tr')];
  sel.forEach((p,i)=>{
    const tds = filas[i].children;
    tds[1].textContent = (p.nombre || '').toUpperCase();  // Nombre MAYÚSCULAS
    tds[2].textContent = p.puesto || '';                  // Área = Puesto
  });

  try{ modal.close(); }catch{ modal.removeAttribute('open'); }
});
btnLimpiarTabla.addEventListener('click', ()=> crearFilas(9));

/* Objetivo (modal) */
document.getElementById('btnObjetivo').addEventListener('click', ()=>{
  objetivoInput.value = objetivoView.value;
  try{ modalObjetivo.showModal(); }catch{ modalObjetivo.setAttribute('open','true'); }
});
document.getElementById('cancelObjetivo').addEventListener('click', ()=>{
  try{ modalObjetivo.close(); }catch{ modalObjetivo.removeAttribute('open'); }
});
document.getElementById('saveObjetivo').addEventListener('click', ()=>{
  objetivoView.value = (objetivoInput.value || '').toUpperCase();
  try{ modalObjetivo.close(); }catch{ modalObjetivo.removeAttribute('open'); }
});

/* Orden del Día: agregar tema */
document.getElementById('agregarTema').addEventListener('click', ()=>{
  const tb = document.querySelector('#tablaOD tbody');
  const n = tb.children.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="num">${n}.</td><td class="tema" contenteditable="true">TEMA</td>`;
  tb.appendChild(tr);
});

/* Fecha por defecto */
document.getElementById('fecha').valueAsDate = new Date();
</script>
</body>
</html>
